<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoVa — Mobil Uyumluluklu Sesli Mod</title>
<style>
body { margin:0; background:black; font-family:"Segoe UI",sans-serif; overflow:hidden; height:100vh; }
#canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
#terminal {
  position:absolute; bottom:0; left:0; width:100%;
  max-height:40%; min-height:100px;
  background: rgba(10,10,10,0.9); border-top:2px solid #00c8ff;
  overflow-y:auto; padding:10px; font-size:16px; box-sizing:border-box;
}
.message { margin:5px 0; white-space:pre-wrap; word-break:break-word; }
.user { color:#00ff88; }
.nova { color:#00c8ff; }
.system { color:#ffcc00; font-style:italic; }
#startBtn {
  position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
  z-index:2000; padding:12px 20px; background:#00d4ff; color:#000; border:none;
  border-radius:8px; font-weight:bold; cursor:pointer;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="terminal"></div>
<audio id="breathSound" src="breath.mp3" preload="auto"></audio>
<button id="startBtn">Nova ile Konuş</button>

<script>
// --- Canvas ve değişkenler ---
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;
let waves = new Array(128).fill(0);
let talking = false;
let novaTalking = false;
let volumeLevel = 0;
let freqData = new Uint8Array(0);
let particles = [];
let flashOpacity = 0;

// --- Particle sınıfı ---
class Particle{
  constructor(x,y,color,size,speedX,speedY,life){ this.x=x; this.y=y; this.color=color; this.size=size; this.speedX=speedX; this.speedY=speedY; this.life=life; }
  update(){ this.x+=this.speedX; this.y+=this.speedY; this.life--; if(this.life>0){ ctx.fillStyle=this.color; ctx.globalAlpha=Math.min(1,this.life/30); ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; } }
}

// --- Renk fonksiyonu ---
function getColor(f,opacity){ if(f<0.33) return `rgba(128,0,128,${opacity})`; else if(f<0.66) return `rgba(0,200,255,${opacity})`; else return `rgba(150,255,255,${opacity})`; }

// --- Canvas çizim ---
function draw(){
  ctx.clearRect(0,0,width,height);
  let bg = ctx.createLinearGradient(0,0,width,height); bg.addColorStop(0,"#000011"); bg.addColorStop(1,"#000033"); ctx.fillStyle=bg; ctx.fillRect(0,0,width,height);

  if(flashOpacity>0){ ctx.fillStyle=`rgba(255,255,255,${flashOpacity})`; ctx.fillRect(0,0,width,height); flashOpacity-=0.05; }

  const cx=width/2, cy=height/2, baseRadius=120;
  ctx.beginPath(); ctx.arc(cx,cy,baseRadius,0,Math.PI*2); ctx.fillStyle="rgb(200,0,0)"; ctx.fill();
  ctx.fillStyle="white"; ctx.font="bold 80px Segoe Script"; ctx.textAlign="center"; ctx.fillText("NoVa", cx, cy+25);

  for(let i=0;i<waves.length;i++){
    const angle=(Math.PI*2/waves.length)*i; let len=baseRadius+waves[i]; const f=i/waves.length;
    let opacity=0.4; if(talking) opacity=0.4+Math.min(1,volumeLevel/100); if(novaTalking) opacity=0.4+0.6*Math.sin(Date.now()/300+i/5);
    const color=getColor(f,opacity);
    let modRadius = baseRadius + Math.sin(Date.now()/500 + i/10)*10;
    const x1=cx+Math.cos(angle)*modRadius; const y1=cy+Math.sin(angle)*modRadius;
    const x2=cx+Math.cos(angle)*len; const y2=cy+Math.sin(angle)*len;
    ctx.strokeStyle=color; ctx.shadowBlur=10; ctx.shadowColor=color; ctx.lineWidth=Math.max(2,waves[i]/15+2);
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    if((talking&&Math.random()<0.05)||(novaTalking&&Math.random()<0.03)) particles.push(new Particle(x2,y2,color,Math.random()*3+1,(Math.random()-0.5)*2,(Math.random()-0.5)*2,20+Math.random()*20));
    if(talking) waves[i]+=((Math.random()*volumeLevel*2.5)-waves[i])*0.3; else if(novaTalking) waves[i]+=((Math.random()*20)-waves[i])*0.1; else waves[i]+=(0-waves[i])*0.05;
    if(waves[i]>40 && Math.random()<0.02) particles.push(new Particle(cx+Math.cos(angle)*(len+10), cy+Math.sin(angle)*(len+10), color, Math.random()*3+1,(Math.random()-0.5)*2,(Math.random()-0.5)*2,15+Math.random()*10));
    if(talking && volumeLevel>60 && Math.random()<0.02){ document.body.style.transform=`translate(${Math.random()*10-5}px,${Math.random()*10-5}px)`; flashOpacity=0.5; }
  }

  for(let i=particles.length-1;i>=0;i--){ particles[i].update(); if(particles[i].life<=0) particles.splice(i,1); }
  document.body.style.transform=`translate(0px,0px)`;
  requestAnimationFrame(draw);
}
draw();
window.addEventListener("resize",()=>{ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; });

// --- Terminal ---
const terminal=document.getElementById("terminal");
function logMessage(sender,text){ const div=document.createElement("div"); div.classList.add("message",sender); div.textContent=(sender==="user"?"🧑 ":"🤖 ")+text; terminal.appendChild(div); terminal.scrollTop=terminal.scrollHeight; }

// --- Mikrofon ---
let audioContext, analyser, source;
async function startMicVisualizer(){
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioContext = new AudioContext();
  source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize=256; freqData=new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);
  talking=true;
  function updateVolume(){
    analyser.getByteFrequencyData(freqData);
    let sum=0; for(let i=0;i<freqData.length;i++) sum+=freqData[i]; volumeLevel=sum/freqData.length;
    if(talking) requestAnimationFrame(updateVolume);
  }
  updateVolume();
  return stream;
}

// --- Speech Recognition ---
let recognition;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SpeechRecognition){
  recognition = new SpeechRecognition();
  recognition.lang = "tr-TR";
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.onstart = ()=> logMessage("system","Dinleniyor...");
  recognition.onend = ()=> { logMessage("system","Dinleme Sonlandı."); talking=false; if(audioContext) audioContext.close(); };
  recognition.onresult = async(e)=>{ const text = e.results[0][0].transcript; logMessage("user",text); await sendMessage(text); };
} else { logMessage("system","❌ Konuşma tanıma bu tarayıcıda desteklenmiyor."); }

// --- Backend ---
const API_URL = "https://nova-chat-d50f.onrender.com/api/chat";
async function sendMessage(message){
  try{
    const response = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({userId:"demoUser",currentChat:"default",message:message,userInfo:{}})
    });
    const data = await response.json();
    await speakAndLog(data.response);
  } catch(err){
    console.error(err);
    await speakAndLog("❌ Sunucuya bağlanılamıyor.");
  }
}

// --- Konuşma Sentezi ---
function speakAndLog(text){
  return new Promise(resolve=>{
    novaTalking=true;
    const cleanText=text.replace(/[^\w\s.,?!çğıöşüÇĞİÖŞÜ]/g,"");
    const utter = new SpeechSynthesisUtterance(cleanText);
    utter.lang="tr-TR";
    const div=document.createElement("div");
    div.classList.add("message","nova");
    terminal.appendChild(div);
    const breathSound=document.getElementById("breathSound");
    let words=text.split(" "), idx=0;
    function speakNextWord(){
      if(idx<words.length){
        div.textContent+=(idx>0?" ":"")+words[idx];
        terminal.scrollTop=terminal.scrollHeight;
        if(Math.random()<0.18){ breathSound.currentTime=0; breathSound.play(); }
        utter.pitch=1+Math.random()*0.1-0.05;
        utter.rate=0.9+Math.random()*0.2;
        idx++; setTimeout(speakNextWord,120+Math.random()*150);
      } else { novaTalking=false; resolve(); }
    }
    speakNextWord();
    window.speechSynthesis.speak(utter);
  });
}

// --- Başlat butonu ---
document.getElementById("startBtn").addEventListener("click", async()=>{
  try{
    await startMicVisualizer();
    if(recognition) recognition.start();
  } catch(e){
    console.error(e);
    logMessage("system","Mikrofon erişimi reddedildi.");
  }
});
</script>
</body>
</html>
