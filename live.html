<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovaLive FULL FIX</title>

<style>
:root{
 --bg:#0d1a21;
 --panel:#13242d;
 --cyan:#4adede;
 --gray:#9aa7b1;
 --red:#ff5c5c;
}
body{
 margin:0;
 background:var(--bg);
 font-family:Segoe UI,sans-serif;
 display:flex;
 justify-content:center;
 align-items:center;
 height:100vh;
 color:white;
}
.chat{
 width:100%;
 max-width:650px;
 height:95vh;
 background:var(--panel);
 border-radius:16px;
 display:flex;
 flex-direction:column;
 box-shadow:0 0 30px rgba(0,0,0,.7);
 overflow:hidden;
 position:relative;
}
.header{
 padding:14px;
 text-align:center;
 font-weight:bold;
 color:var(--cyan);
 border-bottom:1px solid #1e3a44;
}
.camera{background:black;padding:10px}
video{
 width:100%;
 max-height:240px;
 object-fit:cover;
 border-radius:10px;
}
.messages{
 flex:1;
 padding:18px;
 overflow-y:auto;
 display:flex;
 flex-direction:column;
 gap:12px;
}
.msg{
 max-width:80%;
 padding:10px 14px;
 border-radius:14px;
 font-size:.95em;
}
.user{align-self:flex-end;background:#284451}
.nova{align-self:flex-start;background:#1f3944;border-left:3px solid var(--cyan)}
.status{
 padding:10px;
 text-align:center;
 font-size:.85em;
 color:var(--gray);
 border-top:1px solid #1e3a44;
}
.overlay{
 position:absolute;
 inset:0;
 background:rgba(0,0,0,.75);
 display:flex;
 justify-content:center;
 align-items:center;
 z-index:20;
}
.box{
 background:#1b2f38;
 padding:30px 40px;
 border-radius:16px;
 text-align:center;
}
.box h2{color:var(--cyan)}
.box p{color:var(--gray)}
button{
 margin-top:15px;
 padding:12px 26px;
 font-size:16px;
 border:none;
 border-radius:10px;
 background:var(--cyan);
 cursor:pointer;
}
.block{border:2px solid var(--red)}
</style>
</head>

<body>

<div class="chat">

<div id="startOverlay" class="overlay">
 <div class="box">
  <h2>ðŸŸ¢ NovaLive BaÅŸlat</h2>
  <p>Mikrofon ve kamera izni ver</p>
  <button onclick="startNova()">BaÅŸlat</button>
 </div>
</div>

<div id="blockOverlay" class="overlay" style="display:none">
 <div class="box block">
  <h2>ðŸ”´ Nova konuÅŸuyor</h2>
  <p>Nova konuÅŸurken konuÅŸamazsÄ±n</p>
 </div>
</div>

<div class="header">NovaLive ðŸ”´</div>

<div class="camera">
 <video id="video" autoplay playsinline></video>
 <canvas id="canvas" style="display:none"></canvas>
</div>

<div id="messages" class="messages">
 <div class="msg nova"><b>Nova:</b> HazÄ±rÄ±m. Seni dinliyorum.</div>
</div>

<div id="status" class="status">HazÄ±r</div>
</div>

<script>
/* ========= DOM ========= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const messages = document.getElementById("messages");
const statusText = document.getElementById("status");
const startOverlay = document.getElementById("startOverlay");
const blockOverlay = document.getElementById("blockOverlay");

/* ========= STATE ========= */
let imgBase64 = null;
let isNovaSpeaking = false;
let ws = null;

/* ========= WS ========= */
const WS_URL = "wss://nova-chat-d50f.onrender.com/ws/chat";

function connectWS(){
 ws = new WebSocket(WS_URL);
 ws.onopen = () => statusText.innerText = "ðŸŸ¢ BaÄŸlandÄ±";
 ws.onmessage = e => {
  addMsg("nova","<b>Nova:</b> "+e.data);
  speak(e.data);
 };
}

/* ========= CAMERA ========= */
async function startCamera(){
 const stream = await navigator.mediaDevices.getUserMedia({video:true});
 video.srcObject = stream;

 const ctx = canvas.getContext("2d");
 setInterval(()=>{
  if(video.videoWidth===0) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  imgBase64 = canvas.toDataURL("image/jpeg",0.5).split(",")[1];
 },800);
}

/* ========= SPEECH INPUT ========= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recog = new SR();
recog.lang = "tr-TR";
recog.continuous = true;

recog.onresult = e => {
 if(isNovaSpeaking || ws?.readyState !== 1) return;
 const text = e.results[e.results.length-1][0].transcript.trim();
 if(!text) return;

 addMsg("user","<b>Sen:</b> "+text);
 statusText.innerText = "ðŸ§  Nova dÃ¼ÅŸÃ¼nÃ¼yor...";
 blockOverlay.style.display = "flex";

 ws.send(JSON.stringify({message:text,image_data:imgBase64}));
};

recog.onend = ()=>{ if(!isNovaSpeaking) recog.start(); };

/* ========= TTS (FIXED) ========= */
function speak(text){
 isNovaSpeaking = true;
 recog.stop();
 blockOverlay.style.display = "flex";
 statusText.innerText = "ðŸ”Š Nova konuÅŸuyor";

 speechSynthesis.cancel(); // ðŸ”´ SADECE BURADA

 const voices = speechSynthesis.getVoices();
 const tr = voices.find(v=>v.lang==="tr-TR") || voices[0];

 const u = new SpeechSynthesisUtterance(text);
 u.voice = tr;
 u.lang = "tr-TR";
 u.rate = 1.05;

 u.onend = ()=>{
  isNovaSpeaking = false;
  blockOverlay.style.display = "none";
  statusText.innerText = "ðŸŽ§ Dinleniyor...";
  recog.start();
 };

 speechSynthesis.speak(u);
}

/* ========= UI ========= */
function addMsg(type,html){
 const d = document.createElement("div");
 d.className = "msg "+type;
 d.innerHTML = html;
 messages.appendChild(d);
 messages.scrollTop = messages.scrollHeight;
}

/* ========= START ========= */
async function startNova(){
 await navigator.mediaDevices.getUserMedia({audio:true});
 await startCamera();
 connectWS();
 startOverlay.style.display = "none";
 statusText.innerText = "ðŸŽ§ Dinleniyor...";
 recog.start();
}
</script>

</body>
</html>
