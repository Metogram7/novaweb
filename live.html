<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NovaLive PRO Mobile</title>
<style>
:root{ --bg:#0d1a21; --panel:#13242d; --cyan:#00bfff; --red:#ff5c5c; }
*{box-sizing:border-box}
body{ margin:0; background:var(--bg); font-family:sans-serif; height:100vh; overflow:hidden; color:white; display:flex; flex-direction:column; }
.header{ padding:15px; text-align:center; font-weight:bold; color:var(--cyan); background:rgba(0,0,0,0.3); z-index:10; }
.live-container { position: relative; flex:1; display:flex; flex-direction:column; }

/* Kamera AlanÄ± - Mobilde tÃ¼m ekranÄ± kaplasÄ±n ama mesajlara yer kalsÄ±n */
.camera-wrapper { 
    position: relative; 
    width: 100%; 
    height: 40vh; 
    background: #000;
    overflow: hidden;
    flex-shrink: 0;
}
video { width:100%; height:100%; object-fit:cover; transform: scaleX(-1); /* Ayna efekti */ }

/* Mesaj AlanÄ± */
.messages { 
    flex:1; 
    padding:15px; 
    overflow-y:auto; 
    background: var(--panel); 
    display:flex; 
    flex-direction:column; 
    gap:10px;
}
.msg { padding:10px 15px; border-radius:15px; font-size:0.95rem; max-width:85%; line-height:1.4; }
.nova { align-self:flex-start; background:rgba(255,255,255,0.1); border-left:3px solid var(--cyan); }
.user { align-self:flex-end; background:#005f7f; color:white; }

/* Durum Ã‡ubuÄŸu */
.status-bar { padding:10px; background:#111; text-align:center; font-size:0.8rem; color:#888; display:flex; justify-content:center; align-items:center; gap:10px; }
.pulse { width:10px; height:10px; background:var(--cyan); border-radius:50%; animation: pulse 1s infinite; display:none; }
@keyframes pulse { 0% { opacity:1; transform:scale(1); } 100% { opacity:0; transform:scale(2); } }

/* Overlay (BaÅŸlatma EkranÄ±) */
.overlay { position:absolute; inset:0; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:99; }
.box { background:#222; padding:30px; border-radius:20px; text-align:center; width:80%; max-width:300px; border:1px solid #333; }
button { margin-top:20px; padding:15px 30px; border:none; border-radius:50px; background:var(--cyan); color:#000; font-weight:bold; font-size:1.1rem; cursor:pointer; width:100%; }

/* Nova KonuÅŸuyor UyarÄ±sÄ± */
.talking-overlay { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(255,0,0,0.8); padding:10px 20px; border-radius:30px; font-weight:bold; display:none; animation: bounce 1s infinite; z-index:50; }
@keyframes bounce { 0%, 100% { transform:translateX(-50%) translateY(0); } 50% { transform:translateX(-50%) translateY(-5px); } }

</style>
</head>
<body>

<div class="overlay" id="startScreen">
    <div class="box">
        <h2 style="color:var(--cyan); margin:0 0 10px 0;">NovaLive ðŸ”´</h2>
        <p style="color:#aaa; font-size:0.9rem;">Kamera ve Mikrofon izni gereklidir.</p>
        <button onclick="initNova()">BAÅžLAT</button>
    </div>
</div>

<div class="header">NovaLive AI <span style="font-size:0.7em; color:#666;">v2.0</span></div>

<div class="live-container">
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div class="talking-overlay" id="talkingBadge">ðŸ”Š Nova KonuÅŸuyor...</div>
    </div>
    
    <div class="messages" id="msgs">
        <div class="msg nova">Merhaba! Ben Nova. Seni gÃ¶rebiliyor ve duyabiliyorum.</div>
    </div>
    
    <div class="status-bar">
        <div class="pulse" id="micPulse"></div>
        <span id="statusText">Bekleniyor...</span>
    </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const msgs = document.getElementById('msgs');
const statusText = document.getElementById('statusText');
const micPulse = document.getElementById('micPulse');
const talkingBadge = document.getElementById('talkingBadge');

let ws;
let isNovaTalking = false;
let streamInterval;
let recognition;
let synth = window.speechSynthesis;

// 1. BAÅžLATMA VE Ä°ZÄ°NLER
async function initNova() {
    try {
        // iOS Ses Kilidini AÃ§ma Hilesi (Sessiz bir ses Ã§al)
        const dummy = new SpeechSynthesisUtterance("");
        synth.speak(dummy);
        
        document.getElementById('startScreen').style.display = 'none';
        
        // Kamera BaÅŸlat (Ã–n kamera Ã¶ncelikli)
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "user" }, 
            audio: false // Sesi Web Speech API alacak
        });
        video.srcObject = stream;
        
        connectWS();
        startRecognition();
        
        // GÃ¶rÃ¼ntÃ¼ GÃ¶nderme DÃ¶ngÃ¼sÃ¼
        startImageStream();
        
        statusText.textContent = "ðŸŸ¢ BaÄŸlandÄ± - Dinleniyor...";
        micPulse.style.display = "block";
        
    } catch (e) {
        alert("Hata: " + e.message);
        location.reload();
    }
}

// 2. WEBSOCKET BAÄžLANTISI
function connectWS() {
    ws = new WebSocket("wss://nova-chat-d50f.onrender.com/ws/chat");
    
    ws.onopen = () => console.log("WS AÃ§Ä±k");
    
    ws.onmessage = (event) => {
        const text = event.data;
        addMsg(text, "nova");
        speak(text);
    };
    
    ws.onclose = () => {
        statusText.textContent = "ðŸ”´ BaÄŸlantÄ± koptu. Yeniden baÄŸlanÄ±lÄ±yor...";
        setTimeout(connectWS, 3000);
    };
}

// 3. GÃ–RÃœNTÃœ AKIÅžI
function startImageStream() {
    const ctx = canvas.getContext('2d');
    streamInterval = setInterval(() => {
        if (video.videoWidth > 0 && !isNovaTalking) {
            canvas.width = video.videoWidth / 3; // Performans iÃ§in kÃ¼Ã§Ã¼lt
            canvas.height = video.videoHeight / 3;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // GÃ¶rÃ¼ntÃ¼yÃ¼ global deÄŸiÅŸkende tut, ses gelince gÃ¶nderilir
            window.lastFrame = canvas.toDataURL("image/jpeg", 0.6).split(',')[1];
        }
    }, 1000); // Saniyede 1 kare al (Sadece konuÅŸunca gÃ¶nderilir)
}

// 4. SES TANIMA (STT)
function startRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("TarayÄ±cÄ±nÄ±z ses tanÄ±mayÄ± desteklemiyor.");
    
    recognition = new SpeechRecognition();
    recognition.lang = 'tr-TR';
    recognition.continuous = false; // CÃ¼mle bitince durur
    recognition.interimResults = false;

    recognition.onstart = () => {
        if(!isNovaTalking) {
            statusText.textContent = "ðŸŽ§ Dinliyorum...";
            micPulse.style.backgroundColor = "#00bfff";
        }
    };

    recognition.onend = () => {
        // Nova konuÅŸmuyorsa hemen tekrar baÅŸlat (SÃ¼rekli dinleme dÃ¶ngÃ¼sÃ¼)
        if (!isNovaTalking) recognition.start();
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript && !isNovaTalking) {
            addMsg(transcript, "user");
            
            // Backend'e GÃ¶nder
            if (ws && ws.readyState === WebSocket.OPEN) {
                statusText.textContent = "ðŸ§  Nova dÃ¼ÅŸÃ¼nÃ¼yor...";
                micPulse.style.backgroundColor = "#ffcc00";
                
                const payload = {
                    message: transcript,
                    image_data: window.lastFrame || "" // Son yakalanan kareyi gÃ¶nder
                };
                ws.send(JSON.stringify(payload));
            }
        }
    };
    
    recognition.start();
}

// 5. METNÄ° OKUMA (TTS)
function speak(text) {
    isNovaTalking = true;
    recognition.stop(); // Kendi sesini duymamasÄ± iÃ§in durdur
    
    talkingBadge.style.display = "block";
    statusText.textContent = "ðŸ”Š Nova KonuÅŸuyor...";
    micPulse.style.display = "none";
    
    // Sesleri yÃ¼kle (Mobilde bazen geÃ§ yÃ¼klenir)
    let voices = synth.getVoices();
    const trVoice = voices.find(v => v.lang.includes("tr")) || voices[0];
    
    const u = new SpeechSynthesisUtterance(text);
    u.voice = trVoice;
    u.lang = "tr-TR";
    u.rate = 1.0;
    
    u.onend = () => {
        isNovaTalking = false;
        talkingBadge.style.display = "none";
        statusText.textContent = "ðŸŽ§ Dinliyorum...";
        micPulse.style.display = "block";
        recognition.start(); // Tekrar dinlemeye baÅŸla
    };
    
    synth.cancel(); // KuyruÄŸu temizle
    synth.speak(u);
}

// UI YardÄ±mcÄ±sÄ±
function addMsg(text, type) {
    const div = document.createElement('div');
    div.className = `msg ${type}`;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
}
</script>
</body>
</html>