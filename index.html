<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Chat — Tam Sürüm</title>
<style>
body {
  margin:0;
  font-family:"Segoe UI",sans-serif;
  display:flex;
  flex-direction:row;
  height:100vh;
  background:#0d0d0d;
  color:white;
  overflow:hidden;
  transition: background 0.3s, color 0.3s;
}
#sideMenu { width:280px; min-width:150px; max-width:500px; background:#111; border-right:2px solid #00d4ff; display:flex; flex-direction:column; padding:15px; overflow-y:auto; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition: transform 0.3s ease; z-index:1000; }
#sideMenu h3 { margin:0 0 15px 0; color:#00d4ff; font-size:1.4rem; text-align:center; border-bottom:1px solid #00d4ff; padding-bottom:8px; }
#sideMenu button, #sideMenu .chatRow button.chatBtn { margin:5px 0; border:none; border-radius:12px; padding:12px; cursor:pointer; font-weight:bold; transition:0.3s; background:linear-gradient(45deg,#00bfff,#00d4ff); color:#000; text-align:left; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.5); }
#sideMenu button:hover, #sideMenu .chatRow button.chatBtn:hover { background:linear-gradient(45deg,#00d4ff,#0099cc); color:white; }
#sideMenu .deleteBtn { background:#ff5555; flex:none; margin-left:5px; padding:8px 10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.5); transition:0.2s; }
#sideMenu .deleteBtn:hover { background:#ff2222; }
#menu { flex:1; margin-top:10px; overflow-y:auto; }
#dragHandle { width:5px; cursor:col-resize; background:transparent; }
#mainContent { flex:1; display:flex; flex-direction:column; overflow:hidden; }
header { text-align:center; padding:15px; font-size:1.5rem; font-weight:bold; color:#00d4ff; border-bottom:2px solid #00d4ff; background:#080808; display:flex; justify-content:space-between; align-items:center; }
#chatsContainer { flex:1; display:flex; flex-direction:column; overflow-y:auto; position:relative; padding:10px; background:#0d0d0d; }
.chatDiv { flex:1; display:flex; flex-direction:column; overflow-y:auto; padding:20px; }
.msg { max-width:80%; margin:8px 0; padding:10px 16px; border-radius:16px; white-space:pre-wrap; word-wrap:break-word; font-size:1rem; line-height:1.4; position:relative; word-break: break-word; }
.msg .timestamp { font-size:0.7rem; color:#999; position:absolute; bottom:-16px; right:10px; }
.user { background:#b6f0ff; color:#000; align-self:flex-end; margin-left:auto; }
.nova { background:#111; border:1px solid #00d4ff; color:#00d4ff; align-self:flex-start; margin-right:auto; }
#inputArea { display:flex; padding:10px 15px; background:#111; border-top:1px solid #00d4ff; gap:5px; flex-wrap:wrap; }
#input { flex:1; padding:12px 16px; border-radius:12px; border:none; outline:none; font-size:1rem; background:#111; color:white; resize:none; }
button.sendBtn { padding:12px 20px; border-radius:12px; border:none; background:#00d4ff; font-weight:bold; cursor:pointer; }
button#stopBtn { background:#ff5555; }
#quickBtns { display:flex; gap:5px; margin-top:5px; flex-wrap:wrap; }
#quickBtns button { padding:5px 10px; border-radius:8px; border:none; background:#ffdd00; color:#000; cursor:pointer; }
#emojiPicker { display:flex; gap:5px; flex-wrap:wrap; margin-top:5px; }
#emojiPicker span { cursor:pointer; font-size:1.2rem; }
#toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:10px; display:none; z-index:2000; }
@media(max-width:800px){ body { flex-direction:column; } #sideMenu { position:fixed; top:0; left:0; width:80%; max-width:300px; height:100%; transform:translateX(-100%); transition: transform 0.3s ease; } #sideMenu.active { transform:translateX(0); } #dragHandle { display:none; } #mainContent { flex:1; width:100%; margin-left:0; } #inputArea { flex-direction:column; gap:8px; } #input, button.sendBtn, #stopBtn { width:100%; } header { font-size:1.3rem; padding:10px; } #menuToggle { display:block; position:fixed; top:10px; left:10px; z-index:1100; background:#00d4ff; color:#000; border:none; border-radius:8px; padding:8px 12px; font-weight:bold; cursor:pointer; } }
body.light { background:#f5f5f5; color:#111; } 
body.light #sideMenu { background:#ddd; border-right:2px solid #00bfff; } 
body.light #mainContent { background:#fff; } 
body.light .user { background:#00d4ff; color:white; } 
body.light .nova { background:#e0f7ff; border:1px solid #00bfff; color:#111; } 
body.light header { color:#00bfff; border-bottom:2px solid #00bfff; background:#eee; }
</style>
</head>
<body>

<button id="menuToggle">☰ Menü</button>

<div id="sideMenu">
  <h3>💬 Nova Chat</h3>
  <button id="newChatBtn">➕ Yeni Sohbet</button>
  <div id="menu"></div>
  <button id="themeToggle">🌙 Tema Değiştir</button>
</div>
<div id="dragHandle"></div>
<div id="mainContent">
  <header>💬 Nova Chat <span id="novaStatus">Hazır</span></header>
  <div id="chatsContainer"></div>
  <div id="inputArea">
    <textarea id="input" placeholder="Bir şey yaz..." autocomplete="off" rows="1"></textarea>
    <button type="button" class="sendBtn" id="sendBtn">Gönder</button>
    <button type="button" class="sendBtn" id="stopBtn">Durdur</button>
  </div>
  <div id="quickBtns">
    <button>Merhaba</button>
    <button>Nasılsın?</button>
    <button>Hava durumu</button>
  </div>
  <div id="emojiPicker"></div>
</div>

<div id="toast"></div>

<script>
const sideMenu = document.getElementById("sideMenu");
const menuToggle = document.getElementById("menuToggle");
const dragHandle = document.getElementById("dragHandle");
const chatsContainer = document.getElementById("chatsContainer");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const stopBtn = document.getElementById("stopBtn");
const menu = document.getElementById("menu");
const novaStatus = document.getElementById("novaStatus");
const quickBtns = document.getElementById("quickBtns");
const emojiPicker = document.getElementById("emojiPicker");
const newChatBtn = document.getElementById("newChatBtn");
const themeToggle = document.getElementById("themeToggle");
const toast = document.getElementById("toast");
const BACKEND_URL = 'https://nova-chat-d50f.onrender.com/api';

menuToggle.onclick = ()=>{ sideMenu.classList.toggle("active"); };

// Drag handle
let isResizing = false;
dragHandle.addEventListener("mousedown", e=>{ isResizing = true; document.body.style.cursor="col-resize"; });
document.addEventListener("mousemove", e=>{
  if(!isResizing) return;
  let newWidth = e.clientX;
  if(newWidth < 150) newWidth = 150;
  if(newWidth > 500) newWidth = 500;
  sideMenu.style.width = newWidth + "px";
});
document.addEventListener("mouseup", e=>{ if(isResizing){ isResizing=false; document.body.style.cursor="default"; } });

// Tema toggle
themeToggle.onclick = ()=>{ document.body.classList.toggle("light"); showToast("Tema değiştirildi"); };

function showToast(msg, duration=2000){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(()=>{ toast.style.display = "none"; }, duration);
}

// User setup
let userId = localStorage.getItem("nova_user_id");
if(!userId){ userId="user_"+Date.now()+"_"+Math.floor(Math.random()*10000); localStorage.setItem("nova_user_id",userId); }
let currentChat = localStorage.getItem("nova_last_chat") || "default";
let sending = false;
let userInfo = JSON.parse(localStorage.getItem("nova_user_info_"+userId)||"{}");

// Sanitize function (basit)
function sanitize(str){ const temp=document.createElement("div"); temp.textContent=str; return temp.innerHTML; }

function formatDate(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0')+" "+String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0'); }

function renderMenu(){
  menu.innerHTML="";
  const voiceBtn = document.createElement("button");
  voiceBtn.textContent = "Sesli Mod";
  voiceBtn.onclick = () => { window.location.href = "sesli.html"; };
  menu.appendChild(voiceBtn);
  fetch(`${BACKEND_URL}/history?userId=${userId}`)
    .then(r=>r.json())
    .then(data=>{
      Object.keys(data).forEach(cid=>{
        const msgs = data[cid] || [];
        const lastMsg = msgs.length>0 ? msgs[msgs.length-1].text : "Yeni Sohbet";
        addChatToMenu(cid, lastMsg, true);
      });
    });
}

function addChatToMenu(chatId, lastMessage="Yeni Sohbet", skipSave=false){
  if([...menu.querySelectorAll(".chatBtn")].some(b=>b.dataset.id===chatId)) return;
  const row = document.createElement("div"); row.className="chatRow";
  const chatBtn = document.createElement("button"); chatBtn.className="chatBtn"; chatBtn.dataset.id=chatId; chatBtn.onclick=()=>{ loadChat(chatId); };
  const deleteBtn = document.createElement("button"); deleteBtn.className="deleteBtn"; deleteBtn.textContent="❌";
  deleteBtn.onclick = async ()=>{ if(confirm("Bu sohbeti silmek istediğine emin misin?")){ try{ const res = await fetch(`${BACKEND_URL}/delete_chat`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId, chatId}) }); const data = await res.json(); if(data.success){ row.remove(); const div = document.getElementById(chatId); if(div) div.remove(); if(currentChat===chatId) startNewChat(); }else showToast("Silme başarısız: "+(data.error||"")); } catch(err){ console.error(err); showToast("Silme sırasında hata!"); } } };
  row.appendChild(chatBtn); row.appendChild(deleteBtn); menu.appendChild(row); updateChatBtnLabel(chatBtn,lastMessage);
}

function updateChatBtnLabel(button,lastMessage){ if(lastMessage.length>20) lastMessage=lastMessage.slice(0,20)+"..."; button.textContent=lastMessage; }

function loadChat(cid){
  currentChat=cid; Array.from(chatsContainer.children).forEach(c=>c.style.display="none");
  let div=document.getElementById(cid);
  if(!div){ div=document.createElement("div"); div.className="chatDiv"; div.id=cid; chatsContainer.appendChild(div); }
  div.style.display="flex";
  fetch(`${BACKEND_URL}/history?userId=${userId}`)
    .then(r=>r.json())
    .then(data=>{ const msgs = data[cid]||[]; div.innerHTML=""; msgs.forEach(m=> addMessage(m.text,m.sender,div)); });
  localStorage.setItem("nova_last_chat",cid);
}

function startNewChat(){ const newId = "chat_"+Date.now()+"_"+Math.floor(Math.random()*10000); addChatToMenu(newId,"Yeni Sohbet"); loadChat(newId); }

newChatBtn.addEventListener("click", e=>{ e.preventDefault(); startNewChat(); });

function addMessage(text,sender,container=null){
  const parent = container || document.getElementById(currentChat);
  const div=document.createElement("div"); div.className="msg "+sender; div.innerHTML = sanitize(text);
  const timestamp=document.createElement("div"); timestamp.className="timestamp"; timestamp.textContent=formatDate(new Date());
  div.appendChild(timestamp); parent.appendChild(div); parent.scroll({top: parent.scrollHeight, behavior:"smooth"}); return div;
}

// Yazma efekti
async function addTypingMessage(text,sender,container=null,delay=50){
  const parent = container || document.getElementById(currentChat);
  const div=document.createElement("div"); div.className="msg "+sender;
  const timestamp=document.createElement("div"); timestamp.className="timestamp"; timestamp.textContent=formatDate(new Date());
  div.appendChild(timestamp); parent.appendChild(div); parent.scroll({top: parent.scrollHeight, behavior:"smooth"});
  for(let i=0;i<text.length;i++){ div.innerHTML = sanitize(text.slice(0,i+1)); parent.scroll({top: parent.scrollHeight, behavior:"smooth"}); await new Promise(r=>setTimeout(r,delay)); }
  return div;
}

async function sendMessage(msg=null){
  if(sending) return;
  sending=true;
  const text=msg||input.value.trim(); if(!text){sending=false;return;}
  input.value="";
  const chatDiv = document.getElementById(currentChat);
  addMessage(text,"user",chatDiv);
  const typingDiv=addMessage("Nova yazıyor...","nova",chatDiv);
  novaStatus.textContent="Nova yazıyor...";
  try{
    const resHist=await fetch(`${BACKEND_URL}/history?userId=${userId}`);
    const historyData=await resHist.json();
    const chatHistory=historyData[currentChat]||[];
    const res=await fetch(BACKEND_URL+"/chat",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({userId,currentChat,message:text,userInfo,history:chatHistory}) });
    const data=await res.json();
    typingDiv.remove();
    await addTypingMessage(data.response||"⚠️ Hata","nova",chatDiv);
    if(data.updatedUserInfo){ userInfo=data.updatedUserInfo; localStorage.setItem("nova_user_info_"+userId,JSON.stringify(userInfo)); }
  }catch(err){ typingDiv.textContent="Bağlantı hatası 🚫"; console.error(err); }
  novaStatus.textContent="Hazır"; sending=false;
}

input.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
sendBtn.addEventListener("click", e=>{ e.preventDefault(); sendMessage(); });
stopBtn.addEventListener("click", e=>{ e.preventDefault(); });

emojiPicker.innerHTML=""; "😀😂😍😎🤔😢❤️🤖".split("").forEach(e=>{ const span=document.createElement("span"); span.textContent=e; span.onclick=()=>{ input.value+=e; input.focus(); }; emojiPicker.appendChild(span); });

quickBtns.querySelectorAll("button").forEach(b=>{ b.addEventListener("click", e=>{ e.preventDefault(); sendMessage(b.textContent); }); });

window.addEventListener("DOMContentLoaded", ()=>{ loadChat(currentChat); renderMenu(); });
</script>

</body>
</html>
