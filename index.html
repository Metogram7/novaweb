<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Chat — Mobil Uyumlu</title>
<style>
body {
  margin:0;
  font-family:"Segoe UI",sans-serif;
  display:flex;
  height:100vh;
  background:#0d0d0d;
  color:white;
  overflow:hidden;
}

/* --- Sol Menü --- */
#sideMenu {
  width:280px;
  min-width:150px;
  max-width:500px;
  background:#111;
  border-right:2px solid #00d4ff;
  display:flex;
  flex-direction:column;
  padding:15px;
  overflow-y:auto;
  box-shadow:2px 0 10px rgba(0,0,0,0.5);
  transition: transform 0.3s ease;
  z-index:1000;
}
#sideMenu h3 {
  margin:0 0 15px 0;
  color:#00d4ff;
  font-size:1.4rem;
  text-align:center;
  border-bottom:1px solid #00d4ff;
  padding-bottom:8px;
}
#sideMenu button, #sideMenu .chatRow button.chatBtn {
  margin:5px 0;
  border:none;
  border-radius:12px;
  padding:12px;
  cursor:pointer;
  font-weight:bold;
  transition:0.3s;
  background:linear-gradient(45deg,#00bfff,#00d4ff);
  color:#000;
  text-align:left;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.5);
}
#sideMenu button:hover, #sideMenu .chatRow button.chatBtn:hover {
  background:linear-gradient(45deg,#00d4ff,#0099cc);
  color:white;
}
#sideMenu .deleteBtn {
  background:#ff5555;
  flex:none;
  margin-left:5px;
  padding:8px 10px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.5);
  transition:0.2s;
}
#sideMenu .deleteBtn:hover { background:#ff2222; }
#menu { flex:1; margin-top:10px; overflow-y:auto; }

/* Drag handle */
#dragHandle {
  width:5px;
  cursor:col-resize;
  background:transparent;
}

/* --- Ana İçerik --- */
#mainContent {
  flex:1;
  display:flex;
  flex-direction:column;
}

header {
  text-align:center;
  padding:15px;
  font-size:1.5rem;
  font-weight:bold;
  color:#00d4ff;
  border-bottom:2px solid #00d4ff;
  background:#080808;
}

#chatsContainer {
  flex:1;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  position:relative;
  padding:10px;
}

.chatDiv {
  flex:1;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  padding:20px;
}

/* Mesajlar */
.msg {
  max-width:80%;
  margin:8px 0;
  padding:10px 16px;
  border-radius:16px;
  white-space:pre-wrap;
  word-wrap:break-word;
  font-size:1rem;
  line-height:1.4;
  position:relative;
}
.msg .timestamp {
  font-size:0.7rem;
  color:#999;
  position:absolute;
  bottom:-16px;
  right:10px;
}
.user { background:#b6f0ff; color:#000; align-self:flex-end; margin-left:auto; }
.nova { background:#111; border:1px solid #00d4ff; color:#00d4ff; align-self:flex-start; margin-right:auto; }

/* Input alanı */
#inputArea {
  display:flex;
  padding:10px 15px;
  background:#111;
  border-top:1px solid #00d4ff;
  gap:5px;
  flex-wrap:wrap;
}
#input {
  flex:1;
  padding:12px 16px;
  border-radius:12px;
  border:none;
  outline:none;
  font-size:1rem;
  background:#111;
  color:white;
}
button.sendBtn { padding:12px 20px; border-radius:12px; border:none; background:#00d4ff; font-weight:bold; cursor:pointer; }
button#stopBtn { background:#ff5555; }

/* Quick buttons ve emoji picker */
#quickBtns {
  display:flex;
  gap:5px;
  margin-top:5px;
  flex-wrap:wrap;
}
#quickBtns button {
  padding:5px 10px;
  border-radius:8px;
  border:none;
  background:#ffdd00;
  color:#000;
  cursor:pointer;
}
#emojiPicker {
  display:flex;
  gap:5px;
  flex-wrap:wrap;
  margin-top:5px;
}
#emojiPicker span {
  cursor:pointer;
  font-size:1.2rem;
}

/* Responsive */
@media(max-width:800px){
  body { flex-direction:column; }
  #sideMenu {
    position:fixed;
    height:100%;
    transform:translateX(-100%);
  }
  #sideMenu.active { transform:translateX(0); }
  #dragHandle { display:none; }
  #mainContent { flex:1; }
  #inputArea { flex-direction:column; }
  #input, button.sendBtn, #stopBtn { width:100%; }
  header { font-size:1.3rem; padding:10px; }
}

/* Menü aç/kapa butonu mobil */
#menuToggle {
  display:none;
  position:fixed;
  top:10px;
  left:10px;
  z-index:1100;
  background:#00d4ff;
  color:#000;
  border:none;
  border-radius:8px;
  padding:8px 12px;
  font-weight:bold;
  cursor:pointer;
}
@media(max-width:800px){ #menuToggle { display:block; } }

#sideMenu {
  transform: translateX(0) !important;
}
#menuToggle {
  display: none !important;
}
</style>
</head>
<body>

<button id="menuToggle">☰ Menü</button>

<div id="sideMenu">
  <h3>💬 Nova Chat</h3>
  <button id="newChatBtn">➕ Yeni Sohbet</button>
  <div id="menu"></div>
</div>
<div id="dragHandle"></div>
<div id="mainContent">
  <header>💬 Nova Chat <span id="novaStatus">Hazır</span></header>
  <div id="chatsContainer"></div>
  <div id="inputArea">
    <input id="input" type="text" placeholder="Bir şey yaz..." autocomplete="off">
    <button type="button" class="sendBtn" id="sendBtn">Gönder</button>
    <button type="button" class="sendBtn" id="stopBtn">Durdur</button>
  </div>
  <div id="quickBtns">
    <button>Merhaba</button>
    <button>Nasılsın?</button>
    <button>Hava durumu</button>
  </div>
  <div id="emojiPicker"></div>
</div>

<script>
const sideMenu = document.getElementById("sideMenu");
const menuToggle = document.getElementById("menuToggle");
menuToggle.onclick = ()=>{ sideMenu.classList.toggle("active"); };

const dragHandle = document.getElementById("dragHandle");
let isResizing = false;
dragHandle.addEventListener("mousedown", e=>{ isResizing = true; document.body.style.cursor="col-resize"; });
document.addEventListener("mousemove", e=>{
  if(!isResizing) return;
  let newWidth = e.clientX;
  if(newWidth < 150) newWidth = 150;
  if(newWidth > 500) newWidth = 500;
  sideMenu.style.width = newWidth + "px";
});
document.addEventListener("mouseup", e=>{ if(isResizing){ isResizing=false; document.body.style.cursor="default"; } });

const chatsContainer = document.getElementById("chatsContainer");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const stopBtn = document.getElementById("stopBtn");
const menu = document.getElementById("menu");
const novaStatus = document.getElementById("novaStatus");
const quickBtns = document.getElementById("quickBtns");
const emojiPicker = document.getElementById("emojiPicker");
const newChatBtn = document.getElementById("newChatBtn");
const BACKEND_URL = 'https://nova-chat-d50f.onrender.com/api';


let userId = localStorage.getItem("nova_user_id");
if(!userId){
  userId="user_"+Date.now()+"_"+Math.floor(Math.random()*10000);
  localStorage.setItem("nova_user_id",userId);
}

let currentChat = localStorage.getItem("nova_last_chat") || "default";
let sending = false;
let userInfo = JSON.parse(localStorage.getItem("nova_user_info_"+userId)||"{}");

function renderMenu(){
  menu.innerHTML="";
  const voiceBtn = document.createElement("button");
  voiceBtn.textContent = "Sesli Mod";
  voiceBtn.onclick = () => { window.location.href = "sesli.html"; };
  menu.appendChild(voiceBtn);

  fetch(`${BACKEND_URL}/history?userId=${userId}`)
    .then(r => r.json())
    .then(data => {
      Object.keys(data).forEach(cid => {
        const msgs = data[cid] || [];
        const lastMsg = msgs.length > 0 ? msgs[msgs.length-1].text : "Yeni Sohbet";
        addChatToMenu(cid, lastMsg, true);
      });
    });
}

function addChatToMenu(chatId, lastMessage="Yeni Sohbet", skipSave=false){
  if([...menu.querySelectorAll(".chatBtn")].some(b=>b.dataset.id===chatId)) return;
  const row = document.createElement("div");
  row.className="chatRow";
  const chatBtn = document.createElement("button");
  chatBtn.className="chatBtn";
  chatBtn.dataset.id = chatId;
  chatBtn.onclick = ()=>{ loadChat(chatId); };
  const deleteBtn = document.createElement("button");
  deleteBtn.className="deleteBtn";
  deleteBtn.textContent = "❌";
  deleteBtn.onclick = async ()=>{
    if(confirm("Bu sohbeti silmek istediğine emin misin?")){
      try{
        const res = await fetch(`${BACKEND_URL}/delete_chat`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({userId, chatId})
        });
        const data = await res.json();
        if(data.success){
          row.remove();
          const div = document.getElementById(chatId);
          if(div) div.remove();
          if(currentChat===chatId) startNewChat();
        } else { alert("Silme başarısız: " + (data.error||"")); }
      }catch(err){ console.error(err); alert("Silme sırasında hata!"); }
    }
  };
  row.appendChild(chatBtn);
  row.appendChild(deleteBtn);
  menu.appendChild(row);
  updateChatBtnLabel(chatBtn, lastMessage);
}

function updateChatBtnLabel(button, lastMessage){
  if(lastMessage.length>20) lastMessage = lastMessage.slice(0,20) + "...";
  button.textContent = lastMessage;
}

function loadChat(cid){
  currentChat = cid;
  Array.from(chatsContainer.children).forEach(c=>c.style.display="none");
  let div = document.getElementById(cid);
  if(!div){
    div = document.createElement("div");
    div.className="chatDiv";
    div.id=cid;
    chatsContainer.appendChild(div);
  }
  div.style.display="flex";
  fetch(`${BACKEND_URL}/history?userId=${userId}`)
    .then(r=>r.json())
    .then(data=>{
      const msgs = data[cid]||[];
      div.innerHTML="";
      msgs.forEach(m=> addMessage(m.text,m.sender,div));
    });
  localStorage.setItem("nova_last_chat",cid);
}

function startNewChat(){
  const newId = "chat_"+Date.now()+"_"+Math.floor(Math.random()*10000);
  addChatToMenu(newId, "Yeni Sohbet");
  loadChat(newId);
}

newChatBtn.addEventListener("click", e=>{
  e.preventDefault();
  startNewChat();
});

function addMessage(text, sender, container=null){
  const parent = container || document.getElementById(currentChat);
  const div=document.createElement("div");
  div.className="msg "+sender;
  div.innerHTML = text;

  const timestamp=document.createElement("div");
  timestamp.className="timestamp";

  const now = new Date();
  // Türkiye saati (UTC+3)
  const trTime = new Date(now.getTime() + 3*60*60*1000); 
  timestamp.textContent = trTime.getFullYear() + "-" +
                           String(trTime.getMonth()+1).padStart(2,'0') + "-" +
                           String(trTime.getDate()).padStart(2,'0') + " " +
                           String(trTime.getHours()).padStart(2,'0') + ":" +
                           String(trTime.getMinutes()).padStart(2,'0');

  div.appendChild(timestamp);
  parent.appendChild(div);
  parent.scroll({top: parent.scrollHeight,behavior:"smooth"});
  return div;


  div.appendChild(timestamp);
  parent.appendChild(div);
  parent.scroll({top: parent.scrollHeight,behavior:"smooth"});
  return div;
}

async function sendMessage(msg=null){
  if(sending) return;
  sending=true;
  const text=msg||input.value.trim();
  if(!text){sending=false;return;}
  input.value="";
  const chatDiv = document.getElementById(currentChat);
  addMessage(text,"user",chatDiv);
  const typingDiv=addMessage("Nova yazıyor...","nova",chatDiv);
  novaStatus.textContent="Nova yazıyor...";

  try{
    const resHist = await fetch(`${BACKEND_URL}/history?userId=${userId}`);
    const historyData = await resHist.json();
    const chatHistory = historyData[currentChat] || [];
    const res=await fetch(BACKEND_URL+"/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({userId,currentChat,message:text,userInfo,history:chatHistory})
    });
    const data=await res.json();
    typingDiv.textContent="";
    addMessage(data.response||"⚠️ Hata", "nova", chatDiv);
    if(data.updatedUserInfo){
      userInfo=data.updatedUserInfo;
      localStorage.setItem("nova_user_info_"+userId,JSON.stringify(userInfo));
    }
  }catch(err){
    typingDiv.textContent="Bağlantı hatası 🚫";
    console.error(err);
  }
  novaStatus.textContent="Hazır";
  sending=false;
}

input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

sendBtn.addEventListener("click", e=>{
  e.preventDefault();
  sendMessage();
});

stopBtn.addEventListener("click", e=>{
  e.preventDefault();
});

emojiPicker.innerHTML = "";
"😀😂😍😎🤔😢❤️🤖".split("").forEach(e=>{
  const span=document.createElement("span");
  span.textContent=e;
  span.onclick=()=>{ input.value+=e; input.focus(); };
  emojiPicker.appendChild(span);
});

quickBtns.querySelectorAll("button").forEach(b=>{
  b.addEventListener("click", e=>{
    e.preventDefault();
    sendMessage(b.textContent);
  });
});

window.addEventListener("DOMContentLoaded", ()=>{
  loadChat(currentChat);
  renderMenu();
});
</script>

</body>
</html>
